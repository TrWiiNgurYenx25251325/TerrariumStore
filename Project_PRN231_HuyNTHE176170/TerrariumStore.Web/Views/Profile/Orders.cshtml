@model List<TerrariumStore.Web.Models.Order>
@{
    ViewData["Title"] = "Đơn hàng của tôi";
    Layout = "_ProfileLayout";
}

<div class="container py-5">
    <div class="row">
        <div class="col-md-12 mb-4">
            <h2 class="text-center mb-4">Đơn hàng của tôi</h2>
            
            <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
            
            <div id="ordersList">
                <!-- Hiển thị trạng thái loading -->
                <div class="text-center py-5" id="loadingOrders">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-2">Đang tải danh sách đơn hàng...</p>
                </div>
                
                <!-- Hiển thị khi không có đơn hàng -->
                <div id="noOrders" class="alert alert-info text-center" style="display: none;">
                    <i class="fas fa-info-circle me-2"></i> Bạn chưa có đơn hàng nào.
                    <div class="mt-3">
                        <a href="/Product" class="btn btn-outline-primary">Mua sắm ngay</a>
                    </div>
                </div>
                
                <!-- Bảng hiển thị đơn hàng -->
                <div class="table-responsive" id="ordersTable" style="display: none;">
                    <table class="table table-hover table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th>Mã đơn hàng</th>
                                <th>Ngày đặt</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Địa chỉ giao hàng</th>
                                <th>Người nhận</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Dữ liệu đơn hàng sẽ được thêm vào đây bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Kiểm tra xem người dùng đã đăng nhập hay chưa
            const token = localStorage.getItem('token');
            const userId = localStorage.getItem('userId');
            
            if (!token || !userId) {
                window.location.href = '/Home/Login';
                return;
            }
            
            // Lấy danh sách đơn hàng từ API
            $.ajax({
                url: 'https://localhost:7024/api/order/user/' + userId,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(orders) {
                    // Ẩn loading
                    $('#loadingOrders').hide();
                    
                    if (!orders || orders.length === 0) {
                        // Hiển thị thông báo không có đơn hàng
                        $('#noOrders').show();
                    } else {
                        // Hiển thị bảng đơn hàng
                        $('#ordersTable').show();
                        
                        // Tạo các dòng trong bảng
                        let tableRows = '';
                        orders.forEach(function(order) {
                            const orderDate = new Date(order.orderDate).toLocaleDateString('vi-VN', { 
                                day: '2-digit', 
                                month: '2-digit', 
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            const formattedPrice = new Intl.NumberFormat('vi-VN').format(order.totalPrice);
                            
                            let statusBadge = '';
                            switch (order.status) {
                                case 'Pending':
                                    statusBadge = '<span class="badge bg-warning text-dark">Đang xử lý</span>';
                                    break;
                                case 'Shipped':
                                    statusBadge = '<span class="badge bg-info">Đang giao hàng</span>';
                                    break;
                                case 'Completed':
                                    statusBadge = '<span class="badge bg-success">Hoàn thành</span>';
                                    break;
                                case 'Cancelled':
                                    statusBadge = '<span class="badge bg-danger">Đã hủy</span>';
                                    break;
                                default:
                                    statusBadge = '<span class="badge bg-secondary">' + order.status + '</span>';
                                    break;
                            }
                            
                            let recipientInfo = '';
                            if (order.recipientName) {
                                recipientInfo = order.recipientName;
                                if (order.recipientPhone) {
                                    recipientInfo += '<br><small>' + order.recipientPhone + '</small>';
                                }
                            } else {
                                recipientInfo = '<span class="text-muted">Không có thông tin</span>';
                            }
                            
                            tableRows += `
                                <tr>
                                    <td>#${order.id}</td>
                                    <td>${orderDate}</td>
                                    <td>${formattedPrice} VNĐ</td>
                                    <td>${statusBadge}</td>
                                    <td>${order.shippingAddress}</td>
                                    <td>${recipientInfo}</td>
                                    <td>
                                        <a href="/Profile/OrderDetails/${order.id}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> Chi tiết
                                        </a>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        $('#ordersTableBody').html(tableRows);
                    }
                },
                error: function(xhr) {
                    // Ẩn loading
                    $('#loadingOrders').hide();
                    
                    // Hiển thị lỗi
                    $('#errorMessage').text('Không thể tải danh sách đơn hàng. Vui lòng thử lại sau.').show();
                    console.error('Error fetching orders:', xhr);
                }
            });
        });
    </script>
} 